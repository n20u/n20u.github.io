---
categories: [知识梳理]
img_url: assets/img/posts/微服务和分布式系统
---
# 微服务和分布式系统

## 一、分布式和微服务概述

互联网系统的要求：大数据、高并发和快响应。

### 1、分布式系统概述

1. 分布式的切分方法
   1. 水平切分：将同一个系统部署到多台机器上。
   2. 垂直切分：把系统按照业务维度进行拆分。
   3. 混合切分：先把系统按照业务维度切分到不同的服务器群里，然后又将每种业务系统进行水平切分。
2. 分布式系统所面临的问题：异构的机器与网络、普遍的节点故障、不可靠的网络和机器。
3. 分布式的衡量标准：透明性、可伸缩性、可用性、可靠性、高性能、一致性。

### 2、分布式系统的设计原则

1. CAP原则：任何分布式系统都不能同时满足以下三点：
   1. Consistency（一致性）：保持所有节点在同一个时刻具有相同的、逻辑一致的数据。
   2. Availability（可用性）：保证每个请求不管成功还是失败都有响应。
   3. Partition tolerance（分区容忍性）：系统中任何的信息丢失或者失败都不会影响系统的继续运作。
   
   分布式系统只能满足3种情况：
   - CA：在可扩展性上难有建树。
   - CP：通常性能不是特别高。
   - AP：通常对一致性要求低一些，但性能会比较高。
2. BASE理论：对CAP中一致性和可用性权衡的结果。
   1. Basically Available（基本可用）：在分布式系统中，最重要的需求是保证基本可用，有响应结果返回。
   2. Soft state（软状态）：允许系统存在中间状态。
   3. Eventually Consistent（最终一致性）：系统中的所有数据副本经过一定时间后，最终能够达到一致的状态，以保证数据的正确性。

### 3、微服务架构

微服务是分布式系统设计和架构的理念之一，但它并不是为了克服所有的分布式系统的缺陷而设计的，而是为了追求更高的可读性、可用性和简易性，同时也弱化了其一致性。

微服务的风格：
   1. 组件化和服务；
   2. 围绕业务功能组织团队；
   3. 是产品而不是项目；
   4. 强化终端及弱化通道；
   5. 分散治理；
   6. 分散数据管理；
   7. 基础设施自动化；
   8. 容错性设计；
   9. 设计改进。

## 二、Spring Cloud微服务

### 1、服务治理——Eureka

服务治理中心——[Spring Cloud Netflix Eureka](https://spring.io/projects/spring-cloud-netflix)，是微服务（分布式）架构中最基础和最核心的功能组件，它主要对各个服务实例进行管理，包括服务注册和服务发现等。

服务治理中心工作原理：
1. 微服务实例和服务治理中心的关系

   微服务实例（也称为Eureka客户端）通过REST风格请求其配置的属性eureka.client.serviceUrl.defaultZone生成的URL，主动维持其与Eureka服务治理中心（也称为Eureka服务端）之间的关系。
   - 注册：微服务实例会将其自身的信息传递给Eureka服务端，完成注册。
   - 续约：微服务实例会按照一个频率对Eureka服务端维持心跳，告诉Eureka该实例是可用的。
   - 下线：在系统出现故障时，微服务实例会对Eureka服务端发送下线请求。
2. 服务治理中心
   - 相互复制：Eureka本身也会相互注册，以保证高可用和高性能。
   - 服务剔除：将不能正常工作的服务实例剔除出去。
   - 自我保护：在Eureka注册之后，它自己也会通过心跳来告诉自己还活着。
3. 微服务之间的相互调用
   - 服务获取：微服务实例作为Eureka的客户端，从Eureka服务治理中心获取其他微服务实例清单的功能。
   - 服务调用：一个微服务调用另一个微服务的过程。

### 2、客户端负载均衡——Ribbon

服务调用：[Spring Cloud Netflix Ribbon](https://cloud.spring.io/spring-cloud-netflix/multi/multi_spring-cloud-ribbon.html)。

### 3、断路器

断路器：[Spring Cloud Circuit Breaker](https://spring.io/projects/spring-cloud-circuitbreaker)。

1. 雪崩效应：某个微服务不可用，会导致其他正常的服务调用线程的积压，引发其自身也不可用，而且还会蔓延到其他正常的服务上，最终导致所有服务不可用。
2. 熔断：在微服务系统中，某个服务因为请求过大或者出现故障，**断路器**将其从系统中断开，保护其他微服务不因调用它而导致自身瘫痪。
3. 服务降级：在请求数量大大超过系统服务的可接受范围时，将请求直接路由到网络繁忙的结果上，或者屏蔽某些不必要的内容。

### 4、声明式调用——OpenFeign

声明式调用：[Spring Cloud OpenFeign](https://spring.io/projects/spring-cloud-openfeign)。

按照Spring MVC风格的规格描述接口，就能完成REST风格的服务调用。

### 5、网关

网关：[Spring Cloud Gateway](https://spring.io/projects/spring-cloud-gateway)。

网关（gateway）是一种外部网络和内部服务之间的关卡，它可以最先得到外部的请求。软件网关是微服务系统获取请求信息的第一个入口，它的作用是先对请求进行一定的条件过滤后，再分发到源服务器（也就是具体的微服务系统）。

- 路由（route）：路由网关是一个最基本的组件，它由ID、目标URI、断言集合和过滤器集合共同组成，当断言判定为true时，才会匹配到路由。
- 断言（predicate）：它主要是判定当前请求如何匹配到路由，采用的是Java8断言。
- 过滤器（filter）：使用特定工厂构造的SpringFrameworkGatewayFilter实例，在发送下游请求之前或者之后，修改请求和响应。

### 6、配置

配置：[Spring Cloud Config](https://spring.io/projects/spring-cloud-config)。

### 7、全链路追踪

全链路追踪：[Spring Cloud Sleuth](https://spring.io/projects/spring-cloud-sleuth)。

### 8、微服务的监控

微服务的监控：[Spring Boot Admin](http://docs.spring-boot-admin.com/current/)。

## 三、分布式技术

### 1、发号机制

SnowFlake（雪花）算法：

![64位SnowFlake算法约定]({{ page.img_url }}/64位SnowFlake算法约定.png)

### 2、分布式数据库技术

1. 数据库的分表、分库和分区的概念：
   - 分表：在一个或者多个数据库实例内，将一张表拆分为多张表存储。
   - 分库：将一套数据库的设计结构，部署到多个数据库实例的节点中去。
   - 分区：分区技术属于数据库内容的技术，逻辑上仍旧是一张表。
2. 分片算法：
   - 哈希分片之求余算法
   - 一致性哈希算法：假设一个哈希环由$2^{32}$个节点组成，数值的取值范围为区间$[0,2^{32}-1]$。可以根据数据库编号或者其他标识性的属性求其哈希值（hash code），该值就会对应到这个哈希环上的某一点，该点为数据库节点的位置。假设对id也求哈希值，记为n，顺时针找到下一个数据库节点，用来存放数据。
   - 热点分配法：按照一个时间间隔，通过迁徙热点数据的方式，使各个数据库节点的负荷尽可能平衡，从而优化系统性能，减少可能出现的一个数据库繁忙、其他数据库空闲的情况。

### 3、分布式数据库事务

1. 强一致性事务
   1. 两阶段提交协议——XA协议

      首先会引入一个中间件，叫作事务管理器，它是一个协调者。独立数据库的事务管理器称为本地资源管理器。
      1. 事务管理器将数据发送给分布式数据库，并给予预备命令；
      2. 分布式数据库得到数据和预备命令后，对数据进行锁定，向事务管理器返回就绪信息；
      3. 事务管理器收到所有分布式数据库的就绪信息后，发送提交命令；
      4. 分布式数据库收到提交命令后，提交并释放锁定的数据，向事务管理器返回提交成功的信息。
   2. 三阶段提交协议

      三阶段提交协议是在两阶段提交协议的基础上演变而来的，增加了询问和超时的功能。
      询问功能是指在执行XA协议之前，对数据库连接和资源进行验证。
      超时功能是指数据库在执行XA协议的过程中锁定的资源，在超过一个时间戳后，会自动释放锁。
2. 弱一致性事务
   1. 状态表
   2. 可靠事件
   3. 最大尝试
   4. TCC模式：try（尝试）、confirm（确认）和cancel（取消）。

### 4、分布式会话

- 黏性会话
- 服务器会话复制
- 使用缓存：[spring-session-data-redis](https://mvnrepository.com/artifact/org.springframework.session/spring-session-data-redis)
- 持久化到数据库

### 5、分布式系统权限验证

- Spring Security：[spring-boot-starter-security](https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-security)
- OAuth 2.0：[spring-security-oauth2](https://mvnrepository.com/artifact/org.springframework.security.oauth/spring-security-oauth2)

## 四、微服务系统实践

### 1、远程过程调用

RPC的优势：
   - RPC不单可以使用HTTP协议，也可以使用其他协议，如TCP、UDP等，而REST风格只能使用HTTP协议。
   - RPC需要传递的净荷（payload）小，一般是REST风格的20%左右。
   - RPC一般层级较少。

REST风格的优势：
   - 平台无关性
   - 安全性：可以通过防火墙、网关等进行拦截，可以降低恶意攻击的可能性。
   - 独立性：服务消费者不依赖服务提供者的接口和类。

### 2、微服务设计和高并发实践

1. 提高性能：
   1. 数据库优化
   2. 使用缓存
   3. 服务调用优化
   4. 动静分离
   5. 数据库读写分离
2. 服务高可用：
   1. 限流和服务降级
   2. 隔离术
   3. 网关过滤
   4. 断路器